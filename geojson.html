<!DOCTYPE html>
<html lang="sv" xml:lang="sv" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Vilka kommuner har deklarerat klimatnödläge?</title>
	<meta charset="utf-8" />
	<meta name="description" content="Karta som visar vilka kommuner i Sverige som deklarerat klimatnödläge. #parentsforfuture #fridaysforfuture #climateemergencydeclaration #klimatnödläge">
  	<meta name="keywords" content="klimatnödläge, klimataktivism, parents for future, fridays for future">
  	<meta name="author" content="https://github.com/bjarman">
  	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!--<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />-->
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>
    <script type="text/javascript" src="//unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
	<script type="text/javascript" src="//code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		!function(e){e.fn.preloader=function(t){function r(){c=e(i.selector)}function n(){switch(i.type){case"document":default:setTimeout(function(){o()},i.delay)}}function o(){switch(i.removeType){case"fade":a();break;case"remove":default:u()}}function u(){return c.remove()}function a(){return c.fadeOut(i.fadeDuration,f())}function f(){return function(){c.remove()}}var i=e.extend({selector:"#preloader",type:"document",removeType:"fade",fadeDuration:750,delay:0},t),c=null;return r(),this.ready(function(){e(this).trigger("preloader:before"),n(),e(this).trigger("preloader:after")})}}(jQuery);
	</script>
	<script id="mailbody">
Vår gemensamma livsmiljö är hotad! Vi vädjar till kommunens folkvalda att agera kraftfullt och utlysa nödläge för klimatet i vår kommun.
Idag står världen inför ett globalt klimathot som kommer att drabba även oss här i kommunen. Politiska ledare i Sverige och världen tycks leva i förnekelse inför hur konsekvenserna av våra Co2 utsläpp kommer att drabba oss, våra barn och kommande generationer med full kraft. Många kommuner och lokala myndigheter kan nu spela en avgörande roll när det gäller att genomföra de förändringar som krävs för att hejda en katastrof.
På flera ställen runt om i världen har man på det lokala planet utlyst nödläge för klimatet. I städer som Vancouver, Basel, och Oxford har man gått före och visat vägen. Nyligen utlyste även Storbritannien, som första land, klimatnödläge.
Efter att ha tagit del av kommunens handlingsplan med åtgärder för klimat och energiarbetet har vi insett att de åtgärder som hittills tagits i kommunen när det gäller att säkerställa en hållbar utveckling och Co2-neutral livsstil är vällovliga men tyvärr helt otillräckliga.
Vi har därför beslutat att vända oss till våra folkvalda politiker med en akut vädjan.
Vi anser att kommunen, för att möta den akuta klimatkrisen, måste mobilisera alla tänkbara resurser. Det kommer att krävas genomgripande förändringar och en aktiv agenda som i allt sätter vår gemensamma framtid i världen och i kommunen överst. Om vi ska ha minsta chans att lyckas med vår omställning måste alla politiska beslut tas mot bakgrund av den akuta klimatkrisen.
Vi anser att kommunens politiker nu behöver:
1. Erkänna att vi befinner oss i ett klimatnödläge.
2. Ge kommunen i uppdrag att skyndsamt ta fram en klimatnödlägesplan och prioritera planen i kommunens strategiska arbete.
3. Fastställa att kommunen i klimat-nödlägesplanen tar på sig att informera alla kommunens invånare om nödläget och samverka med lokala aktörer för en skyndsam omställning. Kommunen bör även löpande informera invånarna om vilka åtgärder som vidtagits.
4. Erkänna att nödläget varar tills världens nationer säkerställt att målet att den globala uppvärmningen inte passerar ödesdigra 1,5 grader, i enlighet med Parisavtalet.
5. Fastställa att kommunen enligt klimatnödlägesplanen prioriterar att samarbeta med andra kommuner internationellt och nationellt för att bygga upp kompetens och ta kompensatoriskt ansvar för en snabb omställning tills högre politiker tar sitt fulla ansvar för omställningen till en hållbar framtid.
Om vi ska kunna se kommande generationer i ögonen är det dags att agera nu. Vi vill som aktiva och ansvarstagande medborgare stå bakom våra politiker i den omställning som kommer att krävas.
	</script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials.min.js"></script>
	<link type="text/css" rel="stylesheet" href="//stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
	<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials.css" />
	<!--<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials-theme-flat.css" />-->
	<!--<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials-theme-classic.css" />-->
	<!--<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials-theme-minima.css" />-->
	<link type="text/css" rel="stylesheet" href="//cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials-theme-plain.css" />
	<link type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/css/select2.min.css" rel="stylesheet" />
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>
	<script type="text/javascript" src="geojson.js" type="text/javascript"></script>
	<script>
		var entry;
		var entry_array = [];
		var municipal_array = [];
		var municipal_id;

		$(document).ready(function() {
			$('window').preloader();

			function prepareEmail(municipal_id){
				var contact = municipalContactLookup(municipal_id);
				var formattedBody = encodeURIComponent($('#mailbody').html());
				var mailToLink = contact["email"];
				var mailContent = "Subject=Utlys klimatnödläge nu!&";
				mailContent += "body=" + formattedBody;
				mailContent = mailToLink + "?" + mailContent;
				return mailContent;
			}

			var jqxhr = $.getJSON("https://spreadsheets.google.com/feeds/list/1DMrOOb_QxBDZgPzgFrh9GQSx1XR8I1y0ZFaXpItT__w/1/public/full?alt=json", function(data) {
				entry = data.feed.entry;
				$(entry).each(function(){
					municipal_id = this.title.$t;
					var a = this.content.$t.split(",");
					entry_array = a.map(function(item){
					return item.split(": ").pop();
				});
				var ma = {
					"id": this.gsx$code.$t,
					"name": this.gsx$name.$t,
					"population": this.gsx$population.$t,
					"email": this.gsx$email.$t,
					"www": this.gsx$www.$t,
					"phone": this.gsx$phone.$t,
					"ced_status": this.gsx$cedstatus.$t,
					"discussion_status": this.gsx$discussionstatus.$t,
					"citizen_suggest_link": this.gsx$citizensuggestlink.$t,
					"citizen_proposal": this.gsx$citizenproposal.$t,
					"citizen_proposal_ref": this.gsx$citizenproposalref.$t

				};
				municipal_array.push(ma);
				});
			})
			.done(function() {
				init();
  			})
  			.fail(function() {
    			//console.log( "error" );
  			})
  			.always(function() {
    			//console.log( "always" );
  			});
			function ced_status(municipal_id){
				var mid;
				$(municipal_array).each(function(){
				if(this.id == municipal_id){
					mid = this.ced_status;
				}
			});
			return mid;
		}

		function discussion_status(municipal_id){
			var mid;
			$(municipal_array).each(function(){
				if(this.id == municipal_id){
					mid = this.discussion_status;
				}
			});
			return mid;
		}

		function municipalContactLookup(municipal_id){
			var mid;
			$(municipal_array).each(function(){
				if(this.id == municipal_id){
					that = this;
				}
			});
			return that;
		}

		var s = [];
		var map = L.map('map', {minZoom: 5, maxZoom: 8}).setView([63.020557650316576, 18.092765808105472], 5);
		var ol = [];

		function onEachFeature(feature, layer) {
			L.stamp(layer);
			feature.properties.ced = ced_status(feature.properties['ref:se:kommun:kod']);
			feature.properties.discussion_status = discussion_status(feature.properties['ref:se:kommun:kod']);
			var c = feature.properties.ced == 1 ? 'har' : 'har inte';
			var municipal_info = municipalContactLookup(feature.properties['ref:se:kommun:kod']);
			var d = feature.properties.discussion_status == 1 ? 'pågår' : 'pågår inte';
			var popupContent = "<p style='color: red;'><strong>" + feature.properties['name'] + " " + c + " deklarerat klimatnödläge!</strong></p>";
			if(municipal_info.citizen_proposal){
				popupContent += "<p style='color: green;'><strong>Hurra! det " + d + " en process om att utlysa klimatnödläge!</strong></p>";
				popupContent += "<p>Du kan läsa mer om processen och vad du som medborgare kan göra <a target='_blank' href='" + municipal_info.citizen_proposal + "'>här.</a></p>"
			}
			if(!municipal_info.citizen_proposal && municipal_info.discussion_status == 1){
				popupContent += "<p style='color: green;'><strong>Hurra! det " + d + " en process om att utlysa klimatnödläge!</strong></p>";
			}
			if(municipal_info.citizen_suggest_link && !municipal_info.citizen_proposal){
				popupContent += "<p>Bor du i " + feature.properties.name + " så kan du lämna in ett e-förslag <a target='_blank' href='" + municipal_info.citizen_suggest_link + "'>här.</a></p>"
			}
			if(feature.properties.ced == 0){
				popupContent += "<p>Sätt press på " + feature.properties['name'] + " genom att skicka ett mail där du kräver att kommunen utlyser klimatnödläge!</p>";
				popupContent += "<a href='mailto:" + prepareEmail(feature.properties['ref:se:kommun:kod']) + "'>Klicka här för att öppna ett färdigt mail.</a></p>";
			}
			var ced_status_colors = [
				""
			]
			var fillColor = feature.properties.ced == 1 ? {fillColor: '#1CA549'} : feature.properties.discussion_status == 1 ? {fillColor: '#FFCC00'} : {fillColor: '#F2F2F2'};

			layer.setStyle(fillColor);

			if (feature.properties && feature.properties.popupContent) {
				popupContent += feature.properties.popupContent;
			}

			layer.bindPopup(popupContent);

			layer.on('popupopen', function(e){
				$('#municipal').val(e.target._leaflet_id); // Select the option with a value of '1'
				$('#municipal').trigger('change'); // Notify any JS components that the value changed
			});

			s.push({[feature.properties["ref:se:kommun:kod"]]:{
				layer: layer,
        		name: feature.properties.name,
				short_name: feature.properties.short_name,
				ced: feature.properties.ced,
				code: feature.properties["ref:se:kommun:kod"]
       		}});

			ol.push({
				municipal: feature.properties['name'],
				id: layer._leaflet_id
			});
			legend.update(feature.properties['name'], layer._leaflet_id);
		}

		var legend = L.control({position: 'topright'});
	 	legend.onAdd = function (map, ol) {
	    	var div = L.DomUtil.create('div', 'info legend');
	    	var dropDownContent ='<select id="municipal"><option>Välj kommun</option></select>';
	    	div.innerHTML = dropDownContent;
	    	div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
	    	return div;
		};

		legend.update = function(key, value){
			L.DomUtil.get(this._container.firstChild).add(
				new Option(key, value)
			);
		}

		legend.addTo(map);

		var legend2 = L.control({position: 'bottomright'});
	 	legend2.onAdd = function (map, ol) {
	    	var div = L.DomUtil.create('div', 'info legend');
	    	var shareContent ='<div id="shareRoundIcons"></div>';
	    	div.innerHTML = shareContent;
	    	div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
	    	return div;
		};

		legend2.addTo(map);
		L.control.scale().addTo(map);

		map.on('layeradd', function(e) {
    		//console.log(e);
    		// do something related to the layer that was added
		})

		map.on('moveend', function(e){
			//console.log(e);
		});

		map.on('popupopen', function(e){
			//console.log(e);
		});

		var myStyle = {
    		"color": "#666666",
    		"weight": 1,
    		"opacity": 1.0,
    		"fillOpacity": 1.0
		};

		function init(){
			L.geoJSON(gjson, {
				style: myStyle,
				filter: function (feature, layer) {
						if (feature.properties) {
							return feature.properties.underConstruction !== undefined ? !feature.properties.underConstruction : true;
						}
					return false;
				},
				onEachFeature: onEachFeature
			}).addTo(map);

			$('#municipal').select2();

			$('#municipal').on('select2:select', function (e) {
				var data = e.params.data;
				map._layers[data.id].openPopup();
				map.fitBounds(map._layers[data.id].getBounds());
			});

			municipal = document.getElementById("municipal");
			municipal.addEventListener("change", function(){
			map._layers[municipal.value].openPopup();
			map.fitBounds(map._layers[municipal.value].getBounds());
		});

		$("#shareRoundIcons").jsSocials({
    		showLabel: false,
    		showCount: false,
    		shares: ["email", "twitter", "facebook", "linkedin"]
		});
		$("#shareRoundIcons").append('<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a></a>.');
		$("#shareRoundIcons").append('<br /><a target="_blank" href="https://github.com/bjarman/cedmap" style="color: black; font-size: 25px;"><i class="fa fa-github"></i></a>');
		$('window').preloader();
	}
});
</script>
	<style>
		#map {
			width: 100%;
			height: 100%;
			background: transparent;
		}
		html, body {
			height: 100%;
      width: 100%;
			margin: 0;
			padding: 0;
		}
		body {
			background-color: #FFFFFF;
			background-image: url('https://showyourstripes.info/stripes/EUROPE-Sweden--1901-2018-BK.png');
  		background-position: top;
  		background-repeat: repeat-y;
  		background-size: contain;
  		margin: 0;
  		padding: 0;
		}
		#shareRoundIcons{
			text-align: right;
		}
		.jssocials-share-link {
			border-radius: 50%;
			background-color: black;
			color: white !important;
			font-size: 8px;
		}

		#preloader {
		  position: fixed;
		  top: 0;
		  left: 0;
		  width: 100%;
		  height: 100%;
		  z-index: 1000
		}

		#preloader #preloader-inner {
		  display: block;
		  position: relative;
		  left: 50%;
		  top: 50%;
		  width: 150px;
		  height: 150px;
		  margin: -75px 0 0 -75px;
		  border-radius: 50%;
		  border: 3px solid transparent;
		  border-top-color: #3498db;
		  animation: spin 2s linear infinite
		}

		#preloader #preloader-inner:before {
		  content: "";
		  position: absolute;
		  top: 5px;
		  left: 5px;
		  right: 5px;
		  bottom: 5px;
		  border-radius: 50%;
		  border: 3px solid transparent;
		  border-top-color: #e74c3c;
		  animation: spin 3s linear infinite
		}

		#preloader #preloader-inner:after {
		  content: "";
		  position: absolute;
		  top: 15px;
		  left: 15px;
		  right: 15px;
		  bottom: 15px;
		  border-radius: 50%;
		  border: 3px solid transparent;
		  border-top-color: #f9c922;
		  animation: spin 1.5s linear infinite
		}
		@keyframes
		spin { 0% {
		transform:rotate(0deg)
		}

		to { transform: rotate(1turn) }
		}
	</style>
</head>
<body>
	<div id="preloader">
  	<div id="preloader-inner"></div>
	</div>
	<div id='map'></div>
</body>
</html>
